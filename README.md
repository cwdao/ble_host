# BLE Host 上位机程序

一个用于BLE嵌入式系统的Python上位机程序，支持串口数据采集、波形显示和数据处理。

**主版本：PySide6 (Qt) 版本** - 现代化的界面，更好的性能和用户体验。

## 功能特性

### 核心功能

- ✅ **串口通信**: 支持自动检测串口，可配置波特率（9600~230400）
- ✅ **实时波形显示**: 多变量波形实时绘制，支持自动缩放（基于PyQtGraph，高性能）
- ✅ **双帧模式支持**:
  - **信道探测（CS）模式**: 支持多通道IQ数据解析，显示幅值、相位等完整信息
  - **方向估计（DF）模式**: 支持单通道功率数据，显示RMS幅值或功率P，支持信道切换检测
  - 自动识别帧类型，切换模式时自动清空状态
- ✅ **数据处理**: 
  - 频率计算（基于FFT，15秒数据窗口）
  - 统计分析（均值、最大值、最小值、标准差）
  - 实时呼吸估计（支持CS和DF两种模式，可配置更新间隔）
- ✅ **数据保存与加载**:
  - 支持保存所有帧或最近N帧数据
  - 自动保存功能（可配置路径）
  - 加载保存的文件进行离线分析
  - **自动识别文件帧类型**（DF/CS），自动设置相应模式
  - 时间窗滑动条，方便查看不同时间段的数据
- ✅ **命令发送功能**:
  - 支持PING、BLE_SCAN、BLE_CONN、DF_START、DF_CONFIG、DF_STOP等命令
  - 命令格式验证和参数校验
  - 响应解析（OK/ERR/EVT）
- ✅ **友好界面**: 基于PySide6的现代化GUI界面
- ✅ **日志记录**: 实时日志显示，方便调试
- ✅ **可执行文件**: 支持打包成独立的Windows可执行文件

## 系统要求

- Python 3.7+
- Windows 10/11
- 串口设备（USB转串口适配器或COM端口）

## 安装依赖

```bash
pip install -r requirements.txt
```

主要依赖包括：

- PySide6 - Qt GUI框架
- pyqtgraph - 高性能实时绘图
- matplotlib - 数据分析绘图
- pyserial - 串口通信
- numpy - 数值计算

## 使用方法

### 主版本（PySide6/Qt，推荐）

```bash
python run_qt.py
```

### 旧版本（Tkinter，已弃用）

Tkinter版本仍可使用，但不再维护新功能：

```bash
python run.py
```

> **注意**: 新功能仅在Qt版本中开发，建议使用Qt版本。

---

## 数据协议格式

程序支持帧数据格式：

### 信道探测（CS）帧格式
```
== Basic Report == index:123, timestamp:456789
IQ: ch:0:il,ql,ir,qr;ch:1:il,ql,ir,qr;...
== End Report ==
```
- 支持多通道（通常37-70个通道）
- 包含完整的IQ数据，可计算幅值、相位等信息
- 显示所有数据类型的tab（幅值、相位、Local/Remote幅值相位等）

### 方向估计（DF）帧格式
```
$DF,1,37,123,456789,1234.56
```
- 单行格式，单通道数据
- 格式：`$DF,<版本>,<通道>,<序号>,<时间戳>,<功率值>`
- 显示幅值tab（支持RMS幅值或功率P两种显示方式）
- **支持信道切换检测**：当检测到信道变化时，自动清空新信道的累积数据，重新开始累积

## 打包为可执行文件

### Qt版本打包（推荐）

#### Windows

```bash
build_qt.bat
```

#### Linux/Mac

```bash
chmod +x build_qt.sh
./build_qt.sh
```

生成的可执行文件位于 `dist/BLEHost-Qt-v{版本号}.exe`（Windows）或 `dist/BLEHost-Qt-v{版本号}`（Linux/Mac）

### Tkinter版本打包（旧版）

```bash
build.bat  # Windows
```

### 打包选项说明

- `--clean`: 清理临时文件
- `console=False`: 不显示控制台窗口（GUI模式）
- 可以修改 `build_qt.spec` 文件自定义打包选项
- 版本号会自动从 `config.py` 读取并更新到可执行文件名

## 项目结构

```
ble_host/
├── src/                      # 源代码目录
│   ├── __init__.py
│   ├── main_gui_qt.py        # 主GUI程序（Qt版本，主版本）
│   ├── main_gui.py           # 主GUI程序（Tkinter版本，旧版）
│   ├── serial_reader.py     # 串口读取模块
│   ├── data_parser.py       # 数据解析模块（支持CS/DF双模式）
│   ├── data_processor.py    # 数据处理模块（支持信道切换检测）
│   ├── data_saver.py         # 数据保存/加载模块（支持帧类型识别）
│   ├── breathing_estimator.py # 呼吸估计模块（支持CS/DF双模式）
│   ├── command_interface.py  # 命令接口模块（命令定义、生成、验证、解析）
│   ├── config.py             # 配置管理模块
│   ├── plotter_qt_realtime.py # Qt实时绘图（PyQtGraph）
│   ├── plotter_qt_matplotlib.py # Qt分析绘图（Matplotlib）
│   └── plotter.py            # Tkinter绘图模块（旧版）
├── docs/                     # 文档目录
│   ├── framework.md          # 系统架构文档
│   ├── dataflow.md           # 数据流文档
│   ├── df_mode_analysis.md   # DF模式实现分析报告
│   ├── data_save_feature.md  # 数据保存功能说明
│   ├── uart_command_format.md # UART命令格式文档
│   └── ...                   # 其他文档
├── run_qt.py                 # Qt版本入口（推荐）
├── run.py                     # Tkinter版本入口（旧版）
├── requirements.txt           # Python依赖
├── build_qt.spec             # Qt版本PyInstaller配置
├── build_qt.bat              # Qt版本Windows打包脚本
├── build_qt.sh               # Qt版本Linux/Mac打包脚本
├── build.spec                # Tkinter版本PyInstaller配置（旧版）
├── build.bat                 # Tkinter版本打包脚本（旧版）
├── README.md                 # 本文档
└── README_QT.md              # Qt版本详细说明
```

## 使用说明

### Qt版本（主版本）

#### 1. 连接串口
- 在"连接配置"选项卡中选择串口和波特率
- 选择帧类型（信道探测帧/方向估计帧）
- 点击"连接"按钮

#### 2. 配置通道（CS模式）
- 在"通道配置"选项卡中设置要显示的通道
- 支持三种模式：
  - **间隔X信道**：如间隔4，显示0,4,8,12...
  - **信道范围**：如0-9，显示0到9的所有信道
  - **手动输入**：如0,2,4,6,8，自定义信道列表

#### 3. 查看波形
- 连接成功后，数据会自动显示在波形选项卡中
- **CS模式**：支持多个波形选项卡（幅值、相位、Local/Remote幅值相位等）
- **DF模式**：仅显示幅值tab（支持RMS幅值或功率P两种显示方式）
- 自动显示最近N帧的数据（CS模式默认50帧，DF模式默认1000帧）

#### 4. 文件加载
- 在"文件加载"选项卡中选择保存的数据文件
- **自动识别**：程序会自动识别文件中的帧类型（DF/CS），并设置相应模式
- **时间窗**：加载后可以使用滑动条选择时间窗口进行分析
- **文件信息**：显示文件版本、帧类型、保存时间、帧数等信息

#### 5. 呼吸估计
- 在"呼吸估计"选项卡中查看信号处理结果
- **支持两种模式**：
  - **CS模式**：支持多通道选择，支持自适应信道选择
  - **DF模式**：自动使用当前帧的实际信道，支持信道切换检测
- **DF模式特殊功能**：
  - 自动检测信道变化
  - 信道切换时自动清空新信道的累积数据
  - 重新在新信道上累积足够的数据（默认1000帧）后开始呼吸估计
  - 来回切换多次时，每次切换都会清空新信道的累积数据，重新开始累积
- 在右侧控制面板选择通道和数据类型
- 配置参数并点击"Update"
- 实时模式下会自动定期更新估计结果

#### 6. 数据保存与记录（v3.6.0+）
- **增量记录系统**：采用JSONL格式，支持实时增量写入，解决大量数据保存时的内存问题
- **记录控制**：
  - **开始记录**：手动启动JSONL日志记录
  - **自动开始记录**：勾选后，连接串口且有数据后自动开始记录
  - **停止记录**：长按1秒停止记录（带进度提示）
  - **标记事件**：在记录过程中标记特殊事件（如外部干扰、异常等）
- **状态栏显示**：
  - 记录中：显示 `● 正在记录: {文件名}`
  - 停止后：显示 `✓ 已停止向 {文件名} 记录，累计 {帧数} 帧`
- **文件格式**：
  - 新版本（v3.6.0+）：使用JSONL格式（.jsonl），支持增量追加
  - 旧版本兼容：仍支持加载旧版JSON格式文件
  - 文件自动添加帧类型前缀（DF_/CS_）
- **详细格式说明**：参见 `docs/jsonl_format.md`

#### 7. 命令发送
- 在"命令发送"选项卡中发送UART命令
- 支持的命令类型：
  - **PING**: 连通性测试
  - **BLE_SCAN**: 控制扫描（start/stop）
  - **BLE_CONN**: 连接控制（disconnect）
  - **DF_START**: 配置DF参数并启动
  - **DF_CONFIG**: 动态修改DF参数
  - **DF_STOP**: 停止/禁用CTE
- 命令格式验证和参数校验
- 自动解析响应（OK/ERR/EVT）

#### 8. 特殊功能
- 在"特殊功能"选项卡中访问高级功能
- **呼吸信道自适应**：配置呼吸信道自适应功能，自动选择最佳信道进行呼吸估计

#### 9. 设置
- 在"设置"选项卡中配置应用程序选项
- **主题设置**：选择浅色/深色模式或跟随系统
- **显示控制**：控制日志、版本信息、工具栏等显示选项

### Tkinter版本（旧版）

参考上述说明，功能类似但界面较旧。

## 帧数据模式详解

### 信道探测（CS）模式

1. **启用方式**：在GUI界面选择"信道探测帧"作为帧类型
2. **数据格式**：
   - 帧头：`== Basic Report == index:X, timestamp:Y`
   - IQ数据：`IQ: ch:0:il,ql,ir,qr;ch:1:...` （可能分布在多行）
   - 帧尾：`== End Report ==`
3. **自动处理**：
   - 程序会自动识别帧头并开始新帧
   - 累积多行的IQ数据
   - 检测到帧尾时完成帧并转换为幅值、相位等信息
   - 显示各通道的多种数据类型（幅值、相位、Local/Remote幅值相位等）
4. **显示配置**：
   - 默认显示最近50帧
   - 支持间隔选择、范围选择或手动输入通道
   - 支持呼吸估计功能（支持自适应信道选择）

### 方向估计（DF）模式

1. **启用方式**：在GUI界面选择"方向估计帧"作为帧类型
2. **数据格式**：
   - 单行格式：`$DF,<版本>,<通道>,<序号>,<时间戳>,<功率值>`
   - 示例：`$DF,1,37,123,456789,1234.56`
3. **自动处理**：
   - 程序自动识别DF帧格式（优先级最高）
   - 计算RMS幅值（sqrt(功率值)）
   - 显示幅值波形（横轴：序号，纵轴：幅值或功率）
4. **显示配置**：
   - 默认显示最近1000帧（约20秒@50Hz）
   - 支持RMS幅值或功率P两种显示方式
   - 自动更新显示通道为实际接收的通道
   - 仅启用幅值tab，其他tab自动禁用
5. **信道切换检测**：
   - 自动检测信道变化（通过比较当前帧和上一帧的信道）
   - 信道切换时自动清空新信道的累积数据
   - 重置呼吸估计状态
   - 重新在新信道上累积足够的数据（默认1000帧，可在通道配置中修改）
   - 累积完成后才能开始呼吸估计
   - 来回切换多次时，每次切换都会清空新信道的累积数据，重新开始累积

### 模式切换

- 切换帧类型时，程序会自动：
  - 清空当前数据缓冲区
  - 清空解析器状态
  - 清空所有绘图
  - 更新tab启用状态
  - 更新显示帧数配置

### 文件保存与加载

- **保存格式（v3.6.0+）**：
  - **JSONL格式**：采用增量写入的JSONL格式（.jsonl），每行一个JSON对象
  - **记录类型**：支持meta（元数据）、frame（帧数据）、event（事件标记）、end（结束统计）
  - **增量写入**：实时追加记录，避免内存峰值，支持长时间记录
  - **向后兼容**：仍支持加载旧版JSON格式文件（自动格式检测）
- **记录控制**：
  - 手动控制：点击"开始记录"按钮启动，长按"停止记录"按钮停止
  - 自动模式：勾选"自动开始记录"，连接后自动开始记录
  - 事件标记：记录过程中可随时标记特殊事件
- **加载**：
  - 自动格式检测：自动识别JSONL或JSON格式
  - 自动识别帧类型：加载时自动识别帧类型（DF/CS），自动设置相应模式
  - DF文件：自动设置为方向估计模式，显示幅值tab
  - CS文件：自动设置为信道探测模式，显示所有tab
- **时间窗**：加载文件后可使用滑动条选择时间窗口进行分析
- **详细格式说明**：参见 `docs/jsonl_format.md`

## 自定义数据协议

如果需要自定义数据解析格式，修改 `src/data_parser.py` 中的 `parse()` 方法：

```python
def parse(self, text: str) -> Optional[Dict[str, float]]:
    # 在这里实现你的解析逻辑
    # 返回格式: {"变量名": 数值}
    pass
```

## 故障排除

### 串口连接失败
- 检查串口是否被其他程序占用
- 确认波特率设置正确
- 检查串口驱动是否安装
- 确认选择了正确的帧类型

### 数据无法显示
- 检查数据格式是否符合协议要求
- 查看日志窗口的错误信息
- 确认串口数据传输正常
- **DF模式**：确认数据格式为 `$DF,ver,ch,seq,ts,p_avg`
- **CS模式**：确认数据格式包含 `== Basic Report ==` 和 `== End Report ==`

### 文件加载问题
- 确认文件格式正确（新版本为JSONL格式，旧版本为JSON格式）
- 程序会自动检测文件格式（JSONL或JSON）
- 检查文件版本是否兼容
- 查看日志窗口的错误信息
- **DF文件**：确认文件包含 `frame_type: "direction_estimation"`（JSONL格式在meta记录中）
- **CS文件**：确认文件包含 `frame_type: "channel_sounding"` 或不包含frame_type（向后兼容）
- **JSONL文件**：确保第一行是meta记录（包含`record_type: "meta"`）

### 打包失败
- 确认已安装所有依赖
- 检查Python版本（需要3.7+）
- 查看PyInstaller的错误信息

## 版本说明

### Qt版本（主版本，推荐）

- **框架**: PySide6
- **绘图**: PyQtGraph（实时）+ Matplotlib（分析）
- **特点**: 
  - 现代化界面、高性能
  - 支持双帧模式（CS/DF）
  - 自动帧类型识别
  - 完整的数据保存/加载功能
  - 时间窗滑动条（加载模式）
  - 实时呼吸估计（支持CS/DF双模式）
  - DF模式信道切换检测和数据累积
  - 命令发送功能
- **入口**: `run_qt.py`
- **详细说明**: 参见 `README_QT.md`
- **版本**: v3.6.0

### Tkinter版本（旧版，已弃用）

- **框架**: Tkinter
- **绘图**: Matplotlib
- **状态**: 不再添加新功能，仅维护基本功能
- **入口**: `run.py`

## 开发说明

### 添加新功能

- **新数据处理算法**: 在 `data_processor.py` 中添加方法
- **新绘图类型**: 
  - 实时绘图：在 `plotter_qt_realtime.py` 中扩展
  - 分析绘图：在 `plotter_qt_matplotlib.py` 中扩展
- **GUI改进**: 修改 `main_gui_qt.py`（Qt版本）

### 日志级别

可以在 `main_gui_qt.py` 中修改日志级别：
```python
logging.basicConfig(level=logging.DEBUG)  # 改为DEBUG查看更多信息
```

## 许可证

本项目仅供学习和开发使用。

## 更新日志

### v3.6.0 (2026-01-10)

- ✅ **新增JSONL增量记录系统**
  - 采用JSONL格式（.jsonl），支持增量追加写入
  - 解决大量数据（>10000帧）保存时的内存问题和UI卡顿
  - 支持实时记录：采集过程中自动追加帧到日志
  - 支持手动控制：开始记录、停止记录（长按1秒确认）
  - 支持自动开始记录：连接后自动开始记录
  - 支持事件标记：记录过程中可标记特殊事件
  - 状态栏实时显示记录状态和统计信息
  - 完全向后兼容旧版JSON格式文件

- ✅ **UI改进**
  - "保存与导出"组改为两列布局
  - 停止记录按钮增加长按确认机制（1秒，带进度环）
  - 优化状态栏显示，实时反馈记录状态

- ✅ **文件格式**
  - 新版本使用JSONL格式，支持meta、frame、event、end四种记录类型
  - 自动格式检测：支持加载JSONL和JSON格式
  - 详细格式说明：参见 `docs/jsonl_format.md`

### v3.5.0 (2026-01-03)

- ✅ **新增DF模式信道切换检测功能**
  - 自动检测信道变化（通过比较当前帧和上一帧的信道）
  - 信道切换时自动清空新信道的累积数据
  - 重置呼吸估计状态
  - 重新在新信道上累积足够的数据（默认1000帧，可配置）后开始呼吸估计
  - 来回切换多次时，每次切换都会清空新信道的累积数据，重新开始累积
  
- ✅ **修复信道显示问题**
  - 修复了来回切换后信道显示停留在旧信道的问题
  - 使用 `data_processor.last_frame_channels` 获取当前最新信道
  - 确保显示的信道始终是当前最新的信道

- ✅ **优化代码结构**
  - 删除冗余的数据结构创建代码
  - 统一使用 `reset_adaptive_state()` 重置状态
  - 确保通道配置不影响信道切换检测

- ✅ **完善文档**
  - 更新README和架构文档
  - 添加DF模式信道切换检测的详细说明

### v3.4.0 (2025-12-28)

- ✅ **新增DF模式文件加载自动识别功能**
  - 加载文件时自动识别帧类型（DF/CS）
  - 自动设置相应模式和UI状态
  - 修复DF文件加载后幅值plot不显示的问题
  
- ✅ **完善DF模式支持**
  - 支持RMS幅值或功率P两种显示方式
  - 自动更新显示通道列表
  - 优化DF模式的绘图处理逻辑

- ✅ **模式切换优化**
  - 切换模式时自动清空状态
  - 确保DF和CS模式互不干扰
  - 详细分析报告：`docs/df_mode_analysis.md`

### 主要功能

- 双帧模式支持（CS/DF）
- 自动帧类型识别
- 数据保存/加载（支持帧类型记录）
- 时间窗滑动条（加载模式）
- 实时呼吸估计（CS/DF双模式）
- DF模式信道切换检测和数据累积
- 命令发送功能
- 高性能实时绘图（PyQtGraph）

## 相关文档

- `README_QT.md` - Qt版本详细说明
- `docs/framework.md` - 系统架构文档
- `docs/dataflow.md` - 数据流文档
- `docs/df_mode_analysis.md` - DF模式实现分析报告
- `docs/data_save_feature.md` - 数据保存功能说明
- `docs/jsonl_format.md` - JSONL文件格式详细说明（v3.6.0+）
- `docs/uart_command_format.md` - UART命令格式文档
- `INSTALL.md` - 安装指南

## 联系方式

如有问题或建议，请联系开发者。
